{% extends "base.html" %}

{% block content %}
<h1>{{ event.name }}</h1>
<p><strong>Date:</strong> {{ event.date }}</p>
<p><strong>Location:</strong> {{ event.location }}</p>
<p><strong>Description:</strong> {{ event.description }}</p>

<!-- Event Details Section -->
<h2>Event Details</h2>
<table class="event-details-table">
    <thead>
        <tr>
            <th>Attribute</th>
            <th>Value</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Event Name:</strong></td>
            <td><input type="text" id="event-name-input" value="{{ event.name }}" disabled></td>
            <td><button class="change-button" data-attribute="name" onclick="editEventAttribute('name')">Change Event Name</button></td>
        </tr>
        <tr>
            <td><strong>Event Date:</strong></td>
            <td><input type="date" id="event-date-input" value="{{ event.date }}" disabled></td>
            <td><button class="change-button" data-attribute="date" onclick="editEventAttribute('date')">Change Event Date</button></td>
        </tr>
        <tr>
            <td><strong>Event Description:</strong></td>
            <td><textarea id="event-description-input" disabled>{{ event.description }}</textarea></td>
            <td><button class="change-button" data-attribute="description" onclick="editEventAttribute('description')">Change Event Description</button></td>
        </tr>
    </tbody>
</table>

<!-- Guests Section -->
<h2>Guests</h2>
{% if event.guests %}
<div class="filter">
    <label for="filter-status">Filter by Status:</label>
    <select id="filter-status">
        <option value="all">All</option>
        <option value="accepted">Accepted</option>
        <option value="pending">Pending</option>
        <option value="declined">Declined</option>
    </select>
</div>
<button class="add-guest-button">Add Guest</button>
<table class="guests-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone Number</th>
            <th>Invitation Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for guest in event.guests %}
        <tr>
            <td>{{ guest.name }}</td>
            <td>{{ guest.email }}</td>
            <td>{{ guest.phone }}</td>
            <td>{{ guest.status }}</td>
            <td>
                <button class="delete-guest-button" data-id="{{ guest.guest_id }}">Delete</button>
                <button class="send-invitation-button">Send Invitation</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No guests</p>
{% endif %}

<!-- Add Guest Form -->
<div class="add-guest-form" style="display:none;">
    <h3>Add New Guest</h3>
    <form id="guest-form" onsubmit="submitGuestForm(event)">
        <label for="guest-name">Name:</label>
        <input type="text" id="guest-name" name="name" required><br>
        <label for="guest-email">Email:</label>
        <input type="email" id="guest-email" name="email" required><br>
        <label for="guest-phone">Phone:</label>
        <input type="text" id="guest-phone" name="phone" required><br>
        <button type="submit">Add Guest</button>
    </form>
</div>

<!-- Vendors Section -->
<h2>Vendors</h2>
{% if event.vendors %}
<div class="vendors-list">
    {% for vendor in event.vendors %}
    <div class="vendor">
        <p><strong>Name:</strong> {{ vendor.name }}</p>
        <p><strong>Type:</strong> {{ vendor.type }}</p>
        <p><strong>Description:</strong> {{ vendor.description }}</p>
        
        <h3><strong>Vendor Reviews</strong></h3>
        {% if vendor.reviews %}
        <ul>
            {% for review in vendor.reviews %}
            <li>
                <p><strong>Review:</strong> {{ review.comment }}</p>
                <p><strong>Rating:</strong>
                    {% for i in range(1, 6) %}
                        <img src="{{ url_for('static', filename='images/yellow_star.png') }}" 
                             alt="star" 
                             class="star" 
                             style="width: 20px; height: 20px; {% if i > review.rating %} display: none; {% endif %}">
                    {% endfor %}
                </p>
                <p><strong>Date:</strong> {{ review.review_date }}</p>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No reviews available</p>
        {% endif %}
        
        <div></div>
        <button class="review-vendor-button" onclick="showReviewForm({{ vendor.vendor_id }})">Add Review</button>
        <form id="review-form-{{ vendor.vendor_id }}" class="review-form" style="display:none;" onsubmit="submitReview(event, {{ vendor.vendor_id }})">
            <label for="rating">Rating (1-5):</label>
            <input type="number" id="rating" name="rating" min="1" max="5" required>
            
            <label for="comment">Your Review:</label>
            <textarea id="comment" name="comment" required></textarea>
            
            <button type="submit">Submit Review</button>
        </form>
        </div>
        <div>
        <button class="remove-vendor-button" onclick="removeVendor({{ vendor.vendor_id }})">Remove Vendor</button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>No vendors</p>
{% endif %}

<!-- Tasks Section -->
<h2>Tasks</h2>
<button class="add-task-button" onclick="showAddTaskForm()">Add Task</button>
{% if event.tasks %}
<table class="tasks-table">
    <thead>
        <tr>
            <th>Description</th>
            <th>Status</th>
            <th>Due Date</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for task in event.tasks %}
        <tr>
            <td><input type="text" value="{{ task.description }}" disabled></td>
            <td>
                <select disabled>
                    <option value="pending" {% if task.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </td>
            <td><input type="date" value="{{ task.due_date }}" disabled></td>
            <td>
                <button class="edit-task-button" data-id="{{ task.task_id }}" onclick="editTask(this)">Edit</button>
                <button class="save-task-button" data-id="{{ task.task_id }}" style="display:none;" onclick="saveTask(this)">Save</button>
                <button class="delete-task-button" data-id="{{ task.task_id }}" onclick="deleteTask(this)">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No tasks</p>
{% endif %}

<!-- Add Task Form -->
<div class="add-task-form" style="display:none;">
    <h3>Add New Task</h3>
    <form id="task-form" onsubmit="submitTaskForm(event)">
        <label for="task-desc">Description:</label>
        <input type="text" id="task-desc" name="description" required><br>
        <label for="task-status">Status:</label>
        <select id="task-status" name="status" required>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
        </select><br>
        <label for="task-due-date">Due Date:</label>
        <input type="date" id="task-due-date" name="due_date" required><br>
        <button type="submit">Add Task</button>
    </form>
</div>

<button class="update-event-button" onclick="updateEvent()">Update Event</button>

<script>
function updateEvent() {
const name = document.getElementById('event-name-input').value;
const date = document.getElementById('event-date-input').value;
const description = document.getElementById('event-description-input').value;

fetch(`/events/{{ event.event_id }}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name, date, description })
})
.then(response => response.json())
.then(data => {
    if (data.message) {
        alert('Event updated successfully');
        window.location.href = '/';
    } else {
        alert(`Failed to update event: ${data.error}`);
    }
})
.catch(error => {
    console.error('Error:', error);
    alert('Failed to update event');
});
}

function editEventAttribute(attribute) {
    const inputId = `event-${attribute}-input`;
    const inputElement = document.getElementById(inputId);
    inputElement.disabled = !inputElement.disabled;
    if (!inputElement.disabled) {
        inputElement.focus();
    } else {
        const newValue = inputElement.value;
        fetch(`/events/{{ event.event_id }}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ [attribute]: newValue })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert('Event updated successfully');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update event');
        });
    }
}

function showReviewForm(vendorId) {
    document.getElementById(`review-form-${vendorId}`).style.display = 'block';
}

function submitReview(event, vendorId) {
    event.preventDefault();
    const form = event.target;
    const rating = form.rating.value;
    const comment = form.comment.value;

    fetch('/reviews/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ rating, comment, vendor_id: vendorId, event_id: {{ event.event_id }} })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Review added successfully');
            location.reload();
        } else {
            alert(`Failed to add review: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add review');
    });
}

function removeVendor(vendorId) {
    fetch(`/vendors/${vendorId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            alert('Vendor removed successfully');
            location.reload();
        } else {
            response.json().then(data => alert(data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove vendor');
    });
}

function submitGuestForm(event) {
    event.preventDefault();
    const form = event.target;
    const name = form.name.value;
    const email = form.email.value;
    const phone = form.phone.value;

    fetch('/guests/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, email, phone, status: 'pending', event_id: {{ event.event_id }} })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('Guest added successfully');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add guest');
    });
}

function editTask(button) {
    const row = button.closest('tr');
    row.querySelectorAll('input, select').forEach(element => element.disabled = false);
    button.style.display = 'none';
    row.querySelector('.save-task-button').style.display = 'inline';
}

function saveTask(button) {
    const row = button.closest('tr');
    const taskId = button.getAttribute('data-id');
    const description = row.querySelector('input[type="text"]').value;
    const status = row.querySelector('select').value;
    const dueDate = row.querySelector('input[type="date"]').value;

    fetch(`/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ description, status, due_date: dueDate })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('Task updated successfully');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update task');
    });
}

function deleteTask(button) {
    const taskId = button.getAttribute('data-id');

    fetch(`/tasks/${taskId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            alert('Task deleted successfully');
            location.reload();
        } else {
            response.json().then(data => alert(data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete task');
    });
}

function showAddTaskForm() {
    document.querySelector('.add-task-form').style.display = 'block';
}

function submitTaskForm(event) {
    event.preventDefault();
    const form = event.target;
    const description = form.description.value;
    const status = form.status.value;
    const dueDate = form.due_date.value;

    fetch('/tasks/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ description, status, due_date: dueDate, event_id: {{ event.event_id }} })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('Task added successfully');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add task');
    });
}
</script>
{% endblock %}
